# 🌻 Sunflower 图片压缩小工具项目说明文档

## 项目概述

这是一个基于Electron的桌面应用程序，用于压缩图片文件。该工具使用TinyPNG API进行图片压缩，支持多种图片格式，并提供友好的用户界面。Sunflower图片压缩工具不仅操作简单，而且能够突破TinyPNG官网5MB的文件大小限制，是目前最佳的图片压缩小工具之一。

## 项目结构

```
/sunflower 图片压缩小工具
├── app.js             # 辅助UI交互处理
├── config-manager.js  # 配置管理模块
├── assets/           # 资源文件夹
│   ├── icon.svg      # 应用图标
│   ├── xiangrikui1.ico # Windows图标
│   └── xiangrikui1.icns # macOS图标
├── index.html        # 主界面HTML
├── main.js           # Electron主进程
├── package.json      # 项目依赖配置
├── renderer.js       # 渲染进程（主要业务逻辑）
└── styles.css        # 样式表
```

## 应用启动流程

1. **入口点**: `main.js` - Electron应用的主进程
   - 创建主窗口 (`createWindow` 函数)
   - 加载 `index.html` 作为应用界面
   - 设置IPC通信处理程序，用于文件选择和目录操作

2. **界面加载**: `index.html` - 应用的HTML结构
   - 引入 `styles.css` 样式
   - 定义应用界面布局（上传区域、设置面板、预览区域等）
   - 在底部引入 `renderer.js` 和 `app.js` 脚本

3. **业务逻辑初始化**: `renderer.js` - 渲染进程中的主要业务逻辑
   - 初始化DOM元素引用
   - 设置事件监听器
   - 加载保存的配置（API密钥、目录等）

## 主要功能与代码流程

### 1. 配置管理

**文件**: `config-manager.js`

**主要功能**:
- 管理应用配置（API密钥、使用次数、目录路径等）
- 保存和加载配置到本地文件
- 配置文件存储在用户数据目录中，确保跨平台兼容性

**关键函数**:
- `loadConfig()`: 加载配置文件，如不存在则创建默认配置
- `saveConfig()`: 保存配置到文件
- `getApiKey()/setApiKey()`: 获取/设置API密钥
- 各种getter/setter方法用于访问和修改配置项

### 2. 文件选择与预览

**文件**: `renderer.js`

**UI入口**:
- 拖放区域 (`dropArea`)
- "选择文件"按钮 (`browseBtn`)

**执行流程**:
1. 用户通过拖放或点击按钮选择图片文件
   - 拖放处理: `handleDrop()` → `handleFiles()`
   - 按钮点击: `browseBtn.addEventListener('click')` → `ipcRenderer.invoke('select-files')` → `handleFiles()`

2. 文件处理与预览生成
   - `handleFiles()`: 处理选择的文件
   - `displayFilePreview()`: 为每个文件创建预览元素
   - 预览元素包含图片缩略图、文件名、原始大小和删除按钮

### 3. 图片压缩流程

**文件**: `renderer.js`

**UI入口**:
- "开始压缩"按钮 (`compressBtn`)

**执行流程**:
1. 用户点击"开始压缩"按钮
   - 验证是否选择了图片、输出目录和API密钥
   - 保存API密钥到配置文件
   - 设置TinyPNG API密钥

2. 压缩处理
   - 验证API密钥有效性
   - 获取并显示本月已使用的压缩次数
   - 对每个文件进行压缩处理
   - 根据设置转换格式（如需要）
   - 保存压缩后的文件到输出目录
   - 更新UI显示压缩结果和进度

3. 完成处理
   - 更新状态栏显示压缩完成
   - 更新使用次数统计
   - 启用打开输出文件夹按钮

## 技术实现细节

### API密钥管理

API密钥存储在用户数据目录的配置文件中，而不是项目根目录。这样做的好处是：

1. **安全性**：密钥不会被意外提交到版本控制系统
2. **跨平台兼容**：适应不同操作系统的文件结构
3. **权限问题**：避免在应用安装目录（可能是只读的）写入文件

配置文件路径由`ConfigManager`类的`getUserDataPath()`方法确定：
- 在Windows上通常是：`C:\Users\用户名\AppData\Roaming\sunflower-image-compressor`
- 在macOS上通常是：`/Users/用户名/Library/Application Support/sunflower-image-compressor`

### 图片压缩实现

压缩使用TinyPNG的官方Node.js客户端库`tinify`实现：

```javascript
// 设置API密钥
tinify.key = apiKey;

// 从文件创建source对象
source = tinify.fromFile(file.path);

// 可选的格式转换
if (settings.format !== 'original') {
  source = source.convert({ type: [`image/${settings.format}`] });
}

// 保存压缩后的文件
await source.toFile(outputFilePath);
```

### 跨平台兼容性

应用使用Electron框架确保在Windows和macOS上都能正常运行。关键的跨平台兼容性考虑：

1. **文件路径处理**：使用`path.join()`而不是硬编码路径分隔符
2. **配置存储**：使用Electron的`app.getPath('userData')`获取适合当前平台的用户数据目录
3. **UI设计**：响应式设计适应不同屏幕尺寸和分辨率

## 打包与发布

使用`electron-builder`进行应用打包，支持Windows和macOS平台：

```bash
# 打包Windows版本
npm run build:win

# 打包macOS版本
npm run build:mac
```

打包配置在`package.json`的`build`字段中定义，包括应用图标、安装选项等。

## 性能优化

1. **异步操作**：文件读写和API请求使用异步方式，避免阻塞UI
2. **进度显示**：压缩过程中实时更新进度条，提供良好的用户体验
3. **错误处理**：完善的错误捕获和用户友好的错误提示

## 未来改进方向

1. **批量重命名**：添加批量重命名功能
2. **自定义压缩质量**：支持用户自定义压缩质量（需要其他压缩库支持）
3. **拖放排序**：支持拖放方式重新排序图片
4. **多语言支持**：添加英文等其他语言界面
5. **更多格式支持**：扩展支持更多图片格式

---

© 2023-2024 红雪 - 保留所有权利
