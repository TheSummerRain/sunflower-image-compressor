# sunflower 图片压缩小工具项目说明文档

## 项目概述

这是一个基于Electron的桌面应用程序，用于压缩图片文件。该工具使用TinyPNG API进行图片压缩，支持多种图片格式，并提供友好的用户界面。

## 项目结构

```
/sunflower 图片压缩小工具
├── app.js             # 辅助UI交互处理
├── app-config.json    # 配置文件（自动生成）
├── assets/           # 资源文件夹
│   └── icon.svg      # 应用图标
├── config-manager.js  # 配置管理模块
├── index.html        # 主界面HTML
├── main.js           # Electron主进程
├── package.json      # 项目依赖配置
├── renderer.js       # 渲染进程（主要业务逻辑）
└── styles.css        # 样式表
```

## 应用启动流程

1. **入口点**: `main.js` - Electron应用的主进程
   - 创建主窗口 (`createWindow` 函数)
   - 加载 `index.html` 作为应用界面
   - 设置IPC通信处理程序，用于文件选择和目录操作

2. **界面加载**: `index.html` - 应用的HTML结构
   - 引入 `styles.css` 样式
   - 定义应用界面布局（上传区域、设置面板、预览区域等）
   - 在底部引入 `renderer.js` 脚本

3. **业务逻辑初始化**: `renderer.js` - 渲染进程中的主要业务逻辑
   - 初始化DOM元素引用
   - 设置事件监听器
   - 加载保存的配置（API密钥、目录等）

## 主要功能与代码流程

### 1. 配置管理

**文件**: `config-manager.js`

**主要功能**:
- 管理应用配置（API密钥、使用次数、目录路径等）
- 保存和加载配置到本地文件

**关键函数**:
- `loadConfig()`: 加载配置文件，如不存在则创建默认配置
- `saveConfig()`: 保存配置到文件
- 各种getter/setter方法用于访问和修改配置项

### 2. 文件选择与预览

**文件**: `renderer.js`

**UI入口**:
- 拖放区域 (`dropArea`)
- "选择文件"按钮 (`browseBtn`)

**执行流程**:
1. 用户通过拖放或点击按钮选择图片文件
   - 拖放处理: `handleDrop()` → `handleFiles()`
   - 按钮点击: `browseBtn.addEventListener('click')` → `ipcRenderer.invoke('select-files')` → `handleFiles()`

2. 文件处理与预览生成
   - `handleFiles()`: 处理选择的文件
   - `displayFilePreview()`: 为每个文件创建预览元素
   - 预览元素包含图片缩略图、文件名、原始大小和删除按钮

**关键代码**:
```javascript
// 处理文件选择 (renderer.js 行号约68-106)
browseBtn.addEventListener('click', async () => {
  // 调用主进程打开文件选择对话框
  const filePaths = await ipcRenderer.invoke('select-files', options);
  // 处理选择的文件...
});

// 显示文件预览 (renderer.js 行号约124-198)
function displayFilePreview(files) {
  // 为每个文件创建预览元素...
}
```

### 3. 输出目录选择

**文件**: `renderer.js`

**UI入口**:
- "选择输出目录"按钮 (`outputDirBtn`)

**执行流程**:
1. 用户点击按钮选择输出目录
   - `outputDirBtn.addEventListener('click')` → `ipcRenderer.invoke('select-output-directory')`
2. 保存选择的目录到配置
   - `configManager.setOutputDirectory(dir)`
3. 更新UI状态
   - `updateStatus()` 更新状态栏
   - 启用"打开输出文件夹"按钮

**关键代码**:
```javascript
// 选择输出目录 (renderer.js 行号约233-264)
outputDirBtn.addEventListener('click', async () => {
  // 调用主进程打开目录选择对话框
  const dir = await ipcRenderer.invoke('select-output-directory', options);
  // 保存目录并更新UI...
});
```

### 4. 图片压缩

**文件**: `renderer.js`

**UI入口**:
- "开始压缩"按钮 (`compressBtn`)
- 压缩设置面板（质量滑块、格式选择）

**执行流程**:
1. 用户设置压缩参数并点击压缩按钮
   - `compressBtn.addEventListener('click')`
2. 验证必要条件（已选择文件、输出目录、API密钥）
3. 验证TinyPNG API密钥
   - `tinify.validate()`
4. 对每个文件进行压缩处理
   - 根据文件类型选择处理方式（File对象或文件路径）
   - 应用压缩设置（质量、格式转换）
   - 保存压缩后的文件到输出目录
   - 更新UI显示压缩结果和进度

**关键代码**:
```javascript
// 开始压缩 (renderer.js 行号约277-385)
compressBtn.addEventListener('click', async () => {
  // 验证条件...
  
  // 设置TinyPNG API密钥
  tinify.key = apiKey;
  
  // 获取压缩设置
  const settings = {
    // TinyPNG API 不支持自定义压缩质量
    format: formatSelect.value
  };
  
  // 验证API密钥
  await tinify.validate();
  
  // 处理每个文件
  for (let i = 0; i < previewItems.length; i++) {
    // 压缩处理逻辑...
    
    // 根据设置处理格式转换
    if (settings.format !== 'original') {
      source = source.convert({ type: [`image/${settings.format}`] });
    }
    
    // 保存压缩后的文件
    await source.toFile(outputFilePath);
    
    // 更新UI...
  }
});
```

### 5. API密钥管理与使用统计

**文件**: `renderer.js`

**UI入口**:
- API密钥输入框 (`apiKeyInput`)
- 使用次数显示 (`usageCountDisplay`)

**执行流程**:
1. 页面加载时从配置加载保存的API密钥
   - `document.addEventListener('DOMContentLoaded')` → `configManager.getApiKey()`
2. 验证API密钥并获取使用次数
   - `tinify.validate()` → `tinify.compressionCount`
3. 当API密钥变更时保存并验证
   - `apiKeyInput.addEventListener('blur')`
4. 监控使用次数并在接近限制时提醒用户
   - `checkUsageLimit()`

**关键代码**:
```javascript
// 更新使用次数显示 (renderer.js 行号约407-417)
function updateUsageCount(count) {
  const usageCountSpan = usageCountDisplay.querySelector('span');
  usageCountSpan.textContent = count;
  
  // 根据使用次数更新显示样式
  if (count > 450) {
    usageCountSpan.classList.add('warning');
  } else {
    usageCountSpan.classList.remove('warning');
  }
}

// 检查使用限制 (renderer.js 行号约420-426)
function checkUsageLimit(count) {
  if (count >= 500) {
    alert('警告：您本月的免费使用次数已用完！请考虑更换新的API密钥。');
  } else if (count >= 450) {
    alert(`警告：您本月已使用 ${count} 次，接近500次的免费限制。`);
  }
}
```

## 主进程与渲染进程通信

**文件**: `main.js` 和 `renderer.js`

**通信内容**:
1. 文件选择对话框
   - 渲染进程: `ipcRenderer.invoke('select-files', options)`
   - 主进程: `ipcMain.handle('select-files', async (event, options) => {...})`

2. 输出目录选择对话框
   - 渲染进程: `ipcRenderer.invoke('select-output-directory', options)`
   - 主进程: `ipcMain.handle('select-output-directory', async (event, options) => {...})`

3. 打开文件夹
   - 渲染进程: `ipcRenderer.invoke('open-directory', outputDirectory)`
   - 主进程: `ipcMain.handle('open-directory', async (event, dirPath) => {...})`

## 用户界面组件

**文件**: `index.html` 和 `styles.css`

**主要组件**:
1. 左侧面板
   - 上传区域（拖放区域和文件选择按钮）
   - 压缩设置（格式选择、质量滑块、API密钥输入）
   - 操作按钮（选择输出目录、开始压缩、打开输出文件夹）

2. 右侧面板
   - 文件预览区域
   - 每个文件的预览包含：缩略图、文件名、原始大小、压缩后大小、进度条

3. 状态栏
   - 显示当前状态和操作信息

## 总结

sunflower 图片压缩小工具是一个完整的Electron桌面应用，通过TinyPNG API提供高质量的图片压缩功能。应用采用模块化设计，主要分为配置管理、UI交互和压缩处理三个部分。用户可以通过直观的界面选择文件、调整压缩设置并查看压缩结果。

主要执行流程为：
1. 用户选择图片文件（拖放或文件选择器）
2. 设置压缩参数（质量、输出格式）
3. 选择输出目录
4. 点击压缩按钮开始处理
5. 实时显示压缩进度和结果
6. 完成后可打开输出文件夹查看结果

整个应用的核心业务逻辑主要在`renderer.js`中实现，而配置管理和持久化由`config-manager.js`负责，Electron的主进程通信和窗口管理则在`main.js`中处理。
